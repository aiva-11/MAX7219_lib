volatile char *dirk,*dirf,*dira,*clk,*lat,*out;
int count_str(char *str);
char * rev_string(char *str,int count);
void scroll_display(int len, char *str) ;
int getBitmapIndex(char ch);
void display_char_vertical(int index); 
void toggle_lat( );
void bits_one(int data1, int data2);
void clock(int h);
void write_string( char *str);
void dot_init() {
  // put your setup code here, to run once:
dirf=0x30;
dirk=0x107;
dira=0x21;
*dirf=0xff;
*dirk=0xff;
*dira=0xff;
clk=0x31;
out=0x108;
lat=0x22;
}
const int alphabetBitmaps[53][8] = {
  // Uppercase A-Z
  {0x00, 0x18, 0x24, 0x42, 0x7E, 0x42, 0x42, 0x42}, // A
  {0x00, 0x3E, 0x42, 0x3E, 0x42, 0x42, 0x42, 0x3E}, // B
  {0x00, 0x3C, 0x42, 0x02, 0x02, 0x02, 0x42, 0x3C}, // C
  {0x00, 0x1E, 0x22, 0x42, 0x42, 0x42, 0x22, 0x1E}, // D
  {0x00, 0x7E, 0x02, 0x3E, 0x02, 0x02, 0x02, 0x7E}, // E
  {0x00, 0x7E, 0x02, 0x3E, 0x02, 0x02, 0x02, 0x02}, // F
  {0x00, 0x3C, 0x42, 0x02, 0x72, 0x42, 0x42, 0x3C}, // G
  {0x00, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x42}, // H
  {0x00, 0x3E, 0x08, 0x08, 0x08, 0x08, 0x08, 0x3E}, // I
  {0x00, 0x78, 0x20, 0x20, 0x20, 0x20, 0x22, 0x1C}, // J
  {0x00, 0x22, 0x12, 0x0E, 0x12, 0x22, 0x42, 0x42}, // K
  {0x00, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x7E}, // L
  {0x00, 0x42, 0x66, 0x5A, 0x5A, 0x42, 0x42, 0x42}, // M
  {0x00, 0x42, 0x46, 0x4A, 0x52, 0x62, 0x42, 0x42}, // N
  {0x00, 0x3C, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C}, // O
  {0x00, 0x3E, 0x42, 0x42, 0x3E, 0x02, 0x02, 0x02}, // P
  {0x00, 0x3C, 0x42, 0x42, 0x42, 0x52, 0x22, 0x5C}, // Q
  {0x00, 0x3E, 0x42, 0x42, 0x3E, 0x12, 0x22, 0x42}, // R
  {0x00, 0x3C, 0x42, 0x02, 0x3C, 0x40, 0x42, 0x3C}, // S
  {0x00, 0x7F, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08}, // T
  {0x00, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C}, // U
  {0x00, 0x42, 0x42, 0x42, 0x24, 0x24, 0x18, 0x18}, // V
  {0x00, 0x42, 0x42, 0x5A, 0x5A, 0x5A, 0x66, 0x42}, // W
  {0x00, 0x42, 0x24, 0x18, 0x18, 0x18, 0x24, 0x42}, // X
  {0x00, 0x42, 0x24, 0x18, 0x08, 0x08, 0x08, 0x08}, // Y
  {0x00, 0x7E, 0x04, 0x08, 0x10, 0x20, 0x40, 0x7E}, // Z

  // Lowercase a-z
  {0x00, 0x00, 0x3C, 0x40, 0x7C, 0x42, 0x7C, 0x00}, // a
  {0x00, 0x02, 0x02, 0x3A, 0x46, 0x42, 0x46, 0x3A}, // b
  {0x00, 0x00, 0x3C, 0x42, 0x02, 0x42, 0x3C, 0x00}, // c
  {0x00, 0x40, 0x40, 0x5C, 0x62, 0x42, 0x62, 0x5C}, // d
  {0x00, 0x00, 0x3C, 0x42, 0x7E, 0x02, 0x3C, 0x00}, // e
  {0x00, 0x70, 0x08, 0x3E, 0x08, 0x08, 0x08, 0x08}, // f
  {0x00, 0x5C, 0x62, 0x42, 0x62, 0x5C, 0x40, 0x3C}, // g
  {0x00, 0x02, 0x02, 0x3A, 0x46, 0x42, 0x42, 0x42}, // h
  {0x00, 0x08, 0x00, 0x18, 0x08, 0x08, 0x08, 0x3E}, // i
  {0x00, 0x10, 0x00, 0x30, 0x10, 0x10, 0x12, 0x0E}, // j
  {0x00, 0x02, 0x22, 0x12, 0x0E, 0x12, 0x22, 0x42}, // k
  {0x00, 0x18, 0x08, 0x08, 0x08, 0x08, 0x08, 0x3E}, // l
  {0x00, 0x00, 0x36, 0x4A, 0x4A, 0x42, 0x42, 0x42}, // m
  {0x00, 0x00, 0x3A, 0x46, 0x42, 0x42, 0x42, 0x42}, // n
  {0x00, 0x00, 0x3C, 0x42, 0x42, 0x42, 0x3C, 0x00}, // o
  {0x00, 0x00, 0x3A, 0x46, 0x46, 0x3A, 0x02, 0x02}, // p
  {0x00, 0x00, 0x5C, 0x62, 0x62, 0x5C, 0x40, 0x40}, // q
  {0x00, 0x00, 0x3A, 0x46, 0x02, 0x02, 0x02, 0x02}, // r
  {0x00, 0x3C, 0x02, 0x02, 0x3C, 0x40, 0x40, 0x3E}, //s
  {0x00, 0x08, 0x3E, 0x08, 0x08, 0x08, 0x30, 0x00}, // t
  {0x00, 0x00, 0x42, 0x42, 0x42, 0x62, 0x5C, 0x00}, // u
  {0x00, 0x00, 0x42, 0x42, 0x24, 0x24, 0x18, 0x00}, // v
  {0x00, 0x00, 0x42, 0x42, 0x5A, 0x5A, 0x24, 0x00}, // w
  {0x00, 0x00, 0x42, 0x24, 0x18, 0x24, 0x42, 0x00}, // x
  {0x00, 0x00, 0x42, 0x42, 0x62, 0x5C, 0x40, 0x3C}, // y
  {0x00, 0x00, 0x7E, 0x20, 0x18, 0x04, 0x7E, 0x00}, // z
{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}  // space

};

void write_string( char *str) {
  
bits_one(0x0F,0x00);
toggle_lat();
bits_one(0x0C, 0x01); 
toggle_lat();
bits_one(0x0B, 0x07); 
toggle_lat();
int count=count_str(str);
char *str1=rev_string(str,count);
while(1){
scroll_display(count,str1);
}
}
void clock(int h){
  if(h==1){
    *clk |=0x01;
      delayMicroseconds(100);
  }
  else{
    *clk &= ~0x01;
      delayMicroseconds(100);
  }
}
void bits_one(int data1, int data2){
  char bits;
  for(int i=15; i>=0; i--){
    if(i >= 8){
      bits = (data1 >> (i - 8)) & 1;
    } else {
      bits = (data2 >> i) & 1;
    }
    clock(0);
    if(bits == 1){
      *out |= 0x01;
    }
    else{
      *out &= ~0x01;
    }
    clock(1);
  }
}

void toggle_lat( ){
   *lat |=0x01;
     delayMicroseconds(100);
   *lat &=~0x01;
}
void display_char_vertical(int index){
  char rows[8]={
  0x01,
  0x02,
  0x03,
  0x04,
  0x05,
  0x06,
  0x07,
  0x08
};
  for(int i=0;i<8;i++){
    bits_one(rows[i],alphabetBitmaps[index][i]);
    toggle_lat();
  }
}
int getBitmapIndex(char ch) {
  if (ch >= 'A' && ch <= 'Z') {
    return ch - 'A';
  } else if (ch >= 'a' && ch <= 'z') {
    return ch - 'a' + 26;
  } else {
    return 52; 
  }
}
void scroll_display(int len, char *str) {
  char rows[8]={
  0x01,
  0x02,
  0x03,
  0x04,
  0x05,
  0x06,
  0x07,
  0x08
};
  int total_cols = len * 8 + 32;  
  for (int frame = 0; frame < total_cols; frame++) {
    for (int row = 0; row < 8; row++) {
      int row_data[4] = {0};

      for (int col = 0; col < 32; col++) {
      int abs_col = (total_cols -1-frame) + col;

        if (abs_col >= len * 8) continue; 

        int char_index = abs_col / 8;
        int col_in_char = abs_col % 8;

        char ch = (char_index < len) ? str[char_index] : ' ';
        int bmp_index = getBitmapIndex(ch);
        int col_byte = 0;
        for (int i = 0; i < 8; i++) {
          if ((alphabetBitmaps[bmp_index][i] >> (7-col_in_char)) & 1) {
            col_byte |= (1 << i);
          }
        }
        int bits = (col_byte >> row) & 0x01;
        int module = col / 8;  
        int bit_pos = 7 - (col % 8);
        row_data[module] |= (bits << bit_pos);
      }
      for (int m = 3; m >= 0; m--) {
        bits_one(rows[row], row_data[m]);
      }

      toggle_lat();
    }

    delayMicroseconds(1000); 
  }
}
char * rev_string(char *str,int count){

    char temp;


    for(int i=0;i<count/2;i++){
        temp=str[i];
        str[i]=str[count-i-1];
        str[count-i-1]=temp;
    }
    return str;
}
int count_str(char *str){
  int i=0;
  int count=0;
     while(str[i]!='\0'){

        count++;
        i++;
    }
    return count;
}
